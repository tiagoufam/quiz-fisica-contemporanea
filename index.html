<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Educacional - GitHub Integrado</title>
  <meta name="description" content="Quiz educacional com QR Code e armazenamento de resultados (GitHub ou local), com dashboard imediato." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><text y='1em' font-size='96'>üéì</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--text-primary:#334155;--text-secondary:#64748b;--text-muted:#94a3b8;
      --color-primary:#3b82f6;--color-primary-light:#bfdbfe;--color-secondary:#10b981;--color-secondary-light:#bbf7d0;
      --color-success:#16a34a;--color-success-light:#dcfce7;--color-warning:#d97706;--color-warning-light:#fef3c7;--color-error:#dc2626;--color-error-light:#fecaca;
      --color-purple:#8b5cf6;--color-purple-light:#e9d5ff;--border-color:#e2e8f0;--border-focus:#3b82f6;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px rgba(0,0,0,.1);--shadow-lg:0 10px 15px rgba(0,0,0,.1);
      --gradient-primary:linear-gradient(135deg,#bfdbfe 0%,#e9d5ff 100%);--gradient-success:linear-gradient(135deg,#bbf7d0 0%,#dcfce7 100%);--gradient-warning:linear-gradient(135deg,#fef3c7 0%,#fed7aa 100%);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    body{background:var(--bg-primary);color:var(--text-primary);line-height:1.6;padding:1rem;min-height:100vh}
    .app{max-width:1200px;margin:0 auto;width:100%}
    .card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow-md);margin-bottom:1rem;transition:all .3s ease}
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
    .card-gradient{background:var(--gradient-primary);border:none}
    h1{font-size:2.2rem;font-weight:700;margin-bottom:.5rem;background:linear-gradient(135deg,var(--color-primary),var(--color-purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    h2{font-size:1.6rem;font-weight:600;margin-bottom:1rem}
    h3{font-size:1.1rem;font-weight:600;margin-bottom:.75rem}
    .text-muted{color:var(--text-muted);font-size:.875rem}
    .text-secondary{color:var(--text-secondary)}
    .grid{display:grid;gap:1rem}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    .flex{display:flex;gap:1rem}
    .flex-center{align-items:center;justify-content:center}
    .flex-between{align-items:center;justify-content:space-between}
    .flex-wrap{flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;border:none;border-radius:12px;font-weight:500;font-size:.9rem;cursor:pointer;transition:all .2s ease;text-decoration:none;min-height:44px}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
    .btn-primary{background:var(--color-primary);color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color)}.btn-secondary:hover{background:#e2e8f0}
    .btn-success{background:var(--color-success);color:#fff}.btn-success:hover{background:#15803d}
    .btn-warning{background:var(--color-warning);color:#fff}.btn-warning:hover{background:#b45309}
    .btn-sm{padding:.5rem 1rem;font-size:.8rem;min-height:36px}
    .input{width:100%;padding:.75rem 1rem;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-card);font-size:.9rem}
    .input:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .input-group{margin-bottom:1rem}
    .label{display:block;margin-bottom:.5rem;font-weight:500}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:var(--color-primary-light);color:var(--color-primary);border-radius:999px;font-size:.75rem;font-weight:500;border:1px solid rgba(59,130,246,.2)}
    .pill-success{background:var(--color-success-light);color:var(--color-success);border-color:rgba(22,163,74,.2)}
    .pill-warning{background:var(--color-warning-light);color:var(--color-warning);border-color:rgba(217,119,6,.2)}
    .progress{width:100%;height:8px;background:var(--bg-secondary);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--color-primary),var(--color-purple));border-radius:999px;transition:width .3s ease;position:relative}
    .progress-bar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .qr-container{display:flex;flex-direction:column;align-items:center;padding:1.5rem;background:var(--gradient-primary);border-radius:16px;border:2px dashed var(--color-primary)}
    .qr-code{background:#fff;padding:1rem;border-radius:12px;box-shadow:var(--shadow-md);min-height:200px;min-width:200px;display:flex;align-items:center;justify-content:center}
    .quiz-option{padding:1rem 1.5rem;border:2px solid var(--border-color);border-radius:12px;background:var(--bg-card);cursor:pointer;transition:all .2s ease;margin-bottom:.75rem}
    .quiz-option:hover{border-color:var(--color-primary);background:var(--color-primary-light);transform:translateX(4px)}
    .quiz-option.selected{border-color:var(--color-primary);background:var(--color-primary-light);color:var(--color-primary)}
    .fade-in{animation:fadeIn .5s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-online{color:var(--color-success)}.status-offline{color:var(--color-error)}.status-loading{color:var(--color-warning)}
    .table{width:100%;border-collapse:collapse;background:var(--bg-card);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}
    .table th,.table td{padding:1rem;text-align:left;border-bottom:1px solid var(--border-color)}
    .table th{background:var(--bg-secondary);font-weight:600}
    .hidden{display:none!important}.text-center{text-align:center}
    @media (max-width:768px){.btn{width:100%}.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <!-- CONFIGURA√á√ÉO INICIAL -->
    <div id="config" class="fade-in">
      <div class="card card-gradient">
        <h1>üéì Quiz Educacional - GitHub Integrado</h1>
        <p class="text-secondary mb-4">Configure o reposit√≥rio GitHub (ou use modo local). Resultados s√£o salvos por arquivo JSON √∫nico por aluno.</p>
        <div class="pill mb-4">üîó Integra√ß√£o GitHub ‚Ä¢ üìä Dashboard imediato ‚Ä¢ üì± Mobile First</div>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Configura√ß√£o do Reposit√≥rio GitHub</h3>
        <p class="text-secondary mb-4">Use um token <em>fine-grained</em> com acesso de escrita apenas ao reposit√≥rio de resultados. O token ficar√° no navegador; troque-o ap√≥s o quiz.</p>
        <div class="grid grid-2">
          <div class="input-group">
            <label class="label" for="githubUser">üë§ Usu√°rio/Org GitHub</label>
            <input id="githubUser" class="input" placeholder="ex.: tiagogsantos" />
          </div>
          <div class="input-group">
            <label class="label" for="githubRepo">üìÅ Reposit√≥rio</label>
            <input id="githubRepo" class="input" placeholder="ex.: quiz-fisica" />
          </div>
        </div>
        <div class="grid grid-2">
          <div class="input-group">
            <label class="label" for="githubBranch">üåø Branch (padr√£o: main)</label>
            <input id="githubBranch" class="input" placeholder="main" />
          </div>
          <div class="input-group">
            <label class="label" for="githubToken">üîë Token (opcional p/ escrita)</label>
            <input id="githubToken" class="input" type="password" placeholder="ghp_********" />
            <p class="text-muted mt-1">Sem token ‚Üí modo leitura/local. Com token ‚Üí salva em <code>resultados/AAAA-MM-DD/arquivo.json</code>.</p>
          </div>
        </div>
        <div class="flex">
          <button class="btn btn-primary" id="btnConfigurar">‚úÖ Configurar e Continuar</button>
          <button class="btn btn-secondary" id="btnModoLocal">üíª Usar Modo Local</button>
        </div>
      </div>
    </div>

    <!-- TELA INICIAL -->
    <div id="home" class="hidden fade-in">
      <div class="card card-gradient">
        <div class="flex flex-between flex-wrap">
          <div style="flex:2;min-width:300px;">
            <div class="flex flex-wrap mb-3">
              <div class="pill">üéì Quiz Educacional</div>
              <div class="pill" id="statusGitHub"><span class="status-loading">üîÑ</span> Verificando GitHub...</div>
            </div>
            <h2 id="quiz-title">Quiz de F√≠sica</h2>
            <p class="text-secondary">Resultados s√£o salvos automaticamente (GitHub ou local). O professor acessa o dashboard para an√°lise imediata.</p>
            <div class="flex flex-wrap" style="margin-top:.5rem">
              <div class="pill-success">‚úÖ Auto-save</div>
              <div class="pill-success">üìä Dashboard</div>
              <div class="pill-success">üß™ Sem backend</div>
            </div>
          </div>
          <div style="flex:1;min-width:250px;">
            <div class="qr-container">
              <div class="qr-code"><img id="qrImage" style="max-width:180px;max-height:180px" alt="QR"/></div>
              <p class="text-muted text-center mt-2">QR Code do Quiz</p>
              <div class="flex mt-3">
                <button class="btn btn-secondary btn-sm" id="btnQrLink">üîÑ Atualizar</button>
                <button class="btn btn-secondary btn-sm" id="btnCopiarLink">üìã Copiar Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h3>üë®‚Äçüéì √Årea do Aluno</h3>
          <p class="text-secondary">Digite seu nome e inicie o quiz.</p>
          <div class="input-group">
            <label class="label" for="alunoNome">üìù Seu nome completo</label>
            <input id="alunoNome" class="input" maxlength="60" placeholder="Ex.: Ana Silva Santos" required />
          </div>
          <div class="flex"><button class="btn btn-success" id="btnIniciar">üöÄ Iniciar Quiz</button></div>
          <div class="text-muted" style="margin-top:1rem">Os dados gravados incluem nome, acertos, percentual, tempo e respostas por quest√£o.</div>
        </div>

        <div class="card">
          <h3>üë©‚Äçüè´ √Årea do Professor</h3>
          <p class="text-secondary">Abra o dashboard para ver os resultados coletados.</p>
          <div class="grid">
            <button class="btn btn-primary" id="btnDashboard">üìä Dashboard de An√°lise</button>
            <button class="btn btn-secondary" id="btnConfigurarRepo">‚öôÔ∏è Reconfigurar</button>
            <button class="btn btn-warning" id="btnExportarDados">üì• Exportar Dados</button>
          </div>
          <div class="mt-4">
            <div class="flex flex-between"><span class="text-secondary">Status:</span><span id="connectionStatus" class="status-loading">üîÑ Verificando...</span></div>
            <div class="flex flex-between mt-2"><span class="text-secondary">Resultados Coletados:</span><span id="resultadosCount">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quiz" class="hidden">
      <div class="card">
        <div class="flex flex-between flex-wrap mb-4">
          <div class="pill" id="meta">üìù Quest√£o <span id="qid">1</span> de <span id="qtotal">5</span></div>
          <div class="flex" style="align-items:center;gap:1rem">
            <span class="text-muted">Progresso:</span>
            <div class="progress" style="width:200px"><div class="progress-bar" id="prog" style="width:0%"></div></div>
            <span class="text-muted" id="progText">0%</span>
          </div>
        </div>
        <div class="card" style="background:var(--gradient-primary);border:none">
          <h2 id="qtext" class="mb-4">Carregando pergunta...</h2>
          <div id="olist" class="grid"></div>
        </div>
        <div class="flex mt-4">
          <button class="btn btn-secondary" id="btnSair">‚Üê Voltar</button>
          <div id="autoSaveStatus" class="pill" style="margin-left:auto">üíæ Salvamento autom√°tico ativo</div>
        </div>
      </div>
    </div>

    <!-- RESULTADO -->
    <div id="resultado" class="hidden">
      <div class="card card-gradient text-center">
        <h2 class="mb-4">üéâ Quiz Conclu√≠do!</h2>
        <div id="resumo" class="mb-6"></div>
        <div class="card">
          <h3 class="mb-4">‚úÖ Status do salvamento</h3>
          <div id="saveStatus" class="mb-4"><div class="flex flex-center"><div class="spinner"></div><span class="ml-2">Salvando...</span></div></div>
          <div class="grid grid-2"><button class="btn btn-success" id="btnRefazer">üîÑ Fazer Novamente</button><button class="btn btn-secondary" id="btnVoltar">üè† In√≠cio</button></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="card card-gradient">
        <div class="flex flex-between flex-wrap mb-4">
          <h2>üìä Dashboard de An√°lise</h2>
          <div class="flex"><button class="btn btn-secondary" id="btnAtualizarDados">üîÑ Atualizar</button><button class="btn btn-secondary" id="btnFecharDashboard">‚Üê Voltar</button></div>
        </div>
        <div class="pill mb-4" id="lastUpdate">üïí √öltima atualiza√ß√£o: -</div>
      </div>

      <div class="grid grid-3 mb-4">
        <div class="card text-center" style="background:var(--gradient-success)"><h3 style="color:var(--color-success)">üë• Total de Alunos</h3><div id="totalAlunos" style="font-size:2.6rem;font-weight:bold;color:var(--color-success)">-</div><p class="text-muted">que fizeram o quiz</p></div>
        <div class="card text-center" style="background:var(--gradient-primary)"><h3 style="color:var(--color-primary)">üìä M√©dia Geral</h3><div id="mediaGeral" style="font-size:2.6rem;font-weight:bold;color:var(--color-primary)">-</div><p class="text-muted">de aproveitamento</p></div>
        <div class="card text-center" style="background:var(--gradient-warning)"><h3 style="color:var(--color-warning)">‚úÖ Taxa de Aprova√ß√£o</h3><div id="taxaAprovacao" style="font-size:2.6rem;font-weight:bold;color:var(--color-warning)">-</div><p class="text-muted">‚â• 70%</p></div>
      </div>

      <div class="card">
        <h3 class="mb-4">üìã Resultados Detalhados</h3>
        <div style="overflow-x:auto">
          <table class="table" id="tabelaResultados"><thead><tr><th>#</th><th>üë§ Nome</th><th>‚úÖ Acertos</th><th>üìä %</th><th>‚è∞ Data/Hora</th><th>üéØ Status</th><th>üìà Detalhes</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card"><h3 class="mb-4">üìù An√°lise por Quest√£o</h3><div id="analiseQuestoes"></div></div>
      <div class="card"><h3 class="mb-4">üè∑Ô∏è An√°lise por Descritores</h3><div id="analiseDescritores"></div></div>
    </div>
  </div>

  <script>
    // ===== CONFIG & DADOS =====
    const QUESTOES = [
      {id:1,texto:"Qual √© a velocidade da luz no v√°cuo?",opcoes:["300.000 km/s","299.792.458 m/s","3 √ó 10‚Å∏ m/s","Todas as alternativas est√£o corretas"],correta:3,descritor:"D1 - Constantes f√≠sicas",competencia:"Compreender fen√¥menos f√≠sicos",dificuldade:"F√°cil",tempo_estimado:30},
      {id:2,texto:"O que caracteriza o movimento retil√≠neo uniforme?",opcoes:["Velocidade constante e acelera√ß√£o zero","Velocidade vari√°vel e acelera√ß√£o constante","Velocidade zero e acelera√ß√£o constante","Velocidade e acelera√ß√£o vari√°veis"],correta:0,descritor:"D2 - Cinem√°tica",competencia:"Analisar movimentos",dificuldade:"M√©dio",tempo_estimado:45},
      {id:3,texto:"Segundo a Lei de Ohm, a resist√™ncia el√©trica √©:",opcoes:["R = V √ó I","R = V / I","R = I / V","R = V + I"],correta:1,descritor:"D3 - Eletricidade",competencia:"Aplicar leis f√≠sicas",dificuldade:"F√°cil",tempo_estimado:30},
      {id:4,texto:"A energia cin√©tica de um objeto √© dada por:",opcoes:["Ec = m √ó v","Ec = ¬Ω √ó m √ó v","Ec = ¬Ω √ó m √ó v¬≤","Ec = m √ó v¬≤"],correta:2,descritor:"D4 - Energia",competencia:"Conceitos energ√©ticos",dificuldade:"M√©dio",tempo_estimado:40},
      {id:5,texto:"O princ√≠pio da conserva√ß√£o da energia afirma que:",opcoes:["Pode ser criada mas n√£o destru√≠da","Pode ser destru√≠da mas n√£o criada","N√£o √© criada nem destru√≠da, apenas transformada","Sempre aumenta num sistema fechado"],correta:2,descritor:"D5 - Conserva√ß√£o",competencia:"Princ√≠pios fundamentais",dificuldade:"M√©dio",tempo_estimado:50}
    ];

    const estadoApp = {
      telaAtual:'config', questaoAtual:0, respostas:[], nomeAluno:'', inicioQuiz:null, fimQuiz:null,
      githubConfig:{ user:'', repo:'', token:'', branch:'main', configured:false },
      resultados:[], modoLocal:false
    };

    // ===== HELPERS =====
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);
    const escapeHTML = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const formatarTempo = seg => {const m=Math.floor(seg/60),s=seg%60;return `${m}:${String(s).padStart(2,'0')}`};
    const gerarId = () => Date.now().toString(36)+Math.random().toString(36).slice(2);
    const formatarData = ts => new Date(ts).toLocaleString('pt-BR');

    // Base64 UTF-8 seguro (btoa n√£o lida com acentos)
    const toBase64 = obj => {
      const json = typeof obj === 'string' ? obj : JSON.stringify(obj);
      const bytes = new TextEncoder().encode(json);
      let bin = '';
      for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    };

    const hojeISO = () => new Date().toISOString().slice(0,10); // AAAA-MM-DD

    // ===== TELAS =====
    const mostrarTela = (t) => {
      ['config','home','quiz','resultado','dashboard'].forEach(id=>$(id).classList.add('hidden'));
      $(t).classList.remove('hidden');$(t).classList.add('fade-in');estadoApp.telaAtual=t;
    };

    // ===== GITHUB =====
    const GH_HEADERS = (token) => ({
      'Accept':'application/vnd.github+json',
      ...(token?{'Authorization':`Bearer ${token}`}:{}),
      'X-GitHub-Api-Version':'2022-11-28',
      'Content-Type':'application/json'
    });

    const configurarGitHub = () => {
      const user=$('githubUser').value.trim();
      const repo=$('githubRepo').value.trim();
      const token=$('githubToken').value.trim();
      const branch=$('githubBranch').value.trim()||'main';
      if(!user||!repo){alert('Preencha usu√°rio e reposit√≥rio.');return}
      estadoApp.githubConfig={user,repo,token,branch,configured:true};
      localStorage.setItem('githubConfig',JSON.stringify(estadoApp.githubConfig));
      mostrarTela('home');inicializarHome();
    };

    const usarModoLocal = () => {estadoApp.modoLocal=true;estadoApp.githubConfig.configured=false;mostrarTela('home');inicializarHome()};

    const verificarStatusGitHub = async () => {
      if(estadoApp.modoLocal){$('statusGitHub').innerHTML='<span class="status-offline">üíª</span> Modo Local';$('connectionStatus').innerHTML='<span class="status-offline">üíª Modo Local</span>';return}
      if(!estadoApp.githubConfig.configured){$('statusGitHub').innerHTML='<span class="status-offline">‚ùå</span> N√£o Configurado';$('connectionStatus').innerHTML='<span class="status-offline">‚ùå N√£o Configurado</span>';return}
      try{
        const {user,repo,token} = estadoApp.githubConfig;
        const r = await fetch(`https://api.github.com/repos/${user}/${repo}`,{headers:GH_HEADERS(token)});
        if(r.ok){$('statusGitHub').innerHTML='<span class="status-online">‚úÖ</span> Conectado';$('connectionStatus').innerHTML='<span class="status-online">‚úÖ Conectado</span>'}
        else{$('statusGitHub').innerHTML='<span class="status-offline">‚ùå</span> Reposit√≥rio n√£o encontrado';$('connectionStatus').innerHTML='<span class="status-offline">‚ùå Reposit√≥rio n√£o encontrado</span>'}
      }catch(e){$('statusGitHub').innerHTML='<span class="status-offline">‚ùå</span> Erro de conex√£o';$('connectionStatus').innerHTML='<span class="status-offline">‚ùå</span> Erro de conex√£o'}
    };

    const salvarResultadoGitHub = async (resultado) => {
      if(estadoApp.modoLocal || !estadoApp.githubConfig.configured || !estadoApp.githubConfig.token){salvarResultadoLocal(resultado);return}
      try{
        const {user,repo,token,branch} = estadoApp.githubConfig;
        const dateDir = hojeISO();
        const safeName = resultado.nome.replace(/[^a-zA-Z0-9-_]/g,'-').slice(0,40)||'aluno';
        const fileName = `resultado-${Date.now()}-${safeName}.json`;
        const path = `resultados/${dateDir}/${fileName}`;
        const body = {message:`add: ${resultado.nome} (${resultado.percentual}%)`, content: toBase64(resultado), branch};
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`;
        const res = await fetch(url,{method:'PUT',headers:GH_HEADERS(token),body:JSON.stringify(body)});
        if(res.ok){$('saveStatus').innerHTML='<div style="color:var(--color-success)">‚úÖ Salvo no GitHub!</div>'}
        else{
          const txt = await res.text();
          console.error('Falha GitHub:',res.status,txt);
          $('saveStatus').innerHTML='<div style="color:var(--color-warning)">‚ö†Ô∏è Falha ao salvar no GitHub, usando armazenamento local.</div>';
          salvarResultadoLocal(resultado);
        }
      }catch(err){
        console.error('Erro GitHub:',err);
        $('saveStatus').innerHTML='<div style="color:var(--color-warning)">‚ö†Ô∏è Erro de rede, salvando localmente.</div>';
        salvarResultadoLocal(resultado);
      }
    };

    const salvarResultadoLocal = (resultado) => {
      const arr = JSON.parse(localStorage.getItem('quizResultados')||'[]');
      arr.push(resultado);localStorage.setItem('quizResultados',JSON.stringify(arr));
      $('saveStatus').innerHTML='<div style="color:var(--color-success)">‚úÖ Salvo localmente!</div>';
    };

    const carregarResultados = async () => {
      if(estadoApp.modoLocal || !estadoApp.githubConfig.configured){const local=JSON.parse(localStorage.getItem('quizResultados')||'[]');estadoApp.resultados=local;return local}
      try{
        const {user,repo,token,branch} = estadoApp.githubConfig;
        const base = `https://api.github.com/repos/${user}/${repo}/contents/resultados?ref=${encodeURIComponent(branch)}`;
        const r = await fetch(base,{headers:GH_HEADERS(token)});
        if(!r.ok){throw new Error('Pasta resultados n√£o encontrada')}
        const days = await r.json();
        const arquivos = [];
        for(const day of days){ if(day.type==='dir'){ // listar arquivos do dia
            const r2 = await fetch(day.url,{headers:GH_HEADERS(token)});
            if(r2.ok){ const files = await r2.json(); arquivos.push(...files.filter(f=>f.name.endsWith('.json'))); }
        }}
        const resultados = [];
        for(const f of arquivos){
          try{
            // tentar via download_url; se privado, usar contents API
            if(f.download_url){ const rf = await fetch(f.download_url,{headers:GH_HEADERS(estadoApp.githubConfig.token)}); if(rf.ok){resultados.push(await rf.json()); continue} }
            const rc = await fetch(f.url,{headers:GH_HEADERS(estadoApp.githubConfig.token)});
            if(rc.ok){ const obj = await rc.json(); const decoded = JSON.parse(atob(obj.content)); resultados.push(decoded); }
          }catch(e){console.warn('Erro lendo',f.name,e)}
        }
        estadoApp.resultados = resultados; return resultados;
      }catch(e){ console.error('Erro ao carregar GitHub:',e); const local=JSON.parse(localStorage.getItem('quizResultados')||'[]'); estadoApp.resultados=local; return local; }
    };

    // ===== QR CODE =====
    const gerarQRCode = (img, texto, {size=200,color='3b82f6',bgcolor='ffffff'}={}) => { if(!img) return; img.src=`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(texto)}&color=${color}&bgcolor=${bgcolor}`; img.alt='QR Code'; };
    const atualizarQRLink = () => gerarQRCode($('qrImage'), window.location.href, {size:180,color:'3b82f6'});

    // ===== QUIZ =====
    const iniciarQuiz = () => {
      const nome=$('alunoNome').value.trim(); if(!nome){alert('Digite seu nome.');$('alunoNome').focus();return}
      estadoApp.nomeAluno=nome; estadoApp.questaoAtual=0; estadoApp.respostas=[]; estadoApp.inicioQuiz=new Date();
      mostrarTela('quiz'); mostrarQuestao();
    };

    const mostrarQuestao = () => {
      const q=QUESTOES[estadoApp.questaoAtual]; if(!q){finalizarQuiz();return}
      $('qid').textContent=estadoApp.questaoAtual+1; $('qtotal').textContent=QUESTOES.length; $('qtext').textContent=q.texto;
      const progresso = (estadoApp.questaoAtual/QUESTOES.length)*100; $('prog').style.width=progresso+'%'; $('progText').textContent=Math.round(progresso)+'%';
      const olist=$('olist'); olist.innerHTML='';
      q.opcoes.forEach((op,idx)=>{ const div=document.createElement('div'); div.className='quiz-option fade-in'; div.style.animationDelay=(idx*0.06)+'s'; div.innerHTML=`<div style="display:flex;align-items:center;gap:1rem"><div style="width:32px;height:32px;border-radius:50%;background:var(--color-primary-light);color:var(--color-primary);display:flex;align-items:center;justify-content:center;font-weight:bold">${String.fromCharCode(65+idx)}</div><div style="flex:1">${escapeHTML(op)}</div></div>`; div.addEventListener('click',()=>selecionarOpcao(idx,div)); olist.appendChild(div); });
    };

    const selecionarOpcao = (i, el) => {
      $$('.quiz-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected');
      estadoApp.respostas[estadoApp.questaoAtual] = { questao: estadoApp.questaoAtual, resposta: i, tempo: (new Date()-estadoApp.inicioQuiz), correta: i===QUESTOES[estadoApp.questaoAtual].correta };
      setTimeout(()=>proximaQuestao(), 600);
    };

    const proximaQuestao = () => {
      estadoApp.questaoAtual++; (estadoApp.questaoAtual>=QUESTOES.length)?finalizarQuiz():mostrarQuestao();
    };

    const finalizarQuiz = () => { estadoApp.fimQuiz=new Date(); mostrarTela('resultado'); gerarResultado(); salvarResultadoAutomatico(); };

    // ===== RESULTADOS =====
    const gerarResultado = () => {
      const acertos = estadoApp.respostas.filter(r=>r?.correta).length; const total=QUESTOES.length; const perc=Math.round((acertos/total)*100);
      const tempo = Math.round((estadoApp.fimQuiz-estadoApp.inicioQuiz)/1000);
      $('resumo').innerHTML = `
        <div class="grid grid-3 mb-4">
          <div class="card text-center" style="background:var(--color-success-light)"><h3 style="color:var(--color-success);margin-bottom:.5rem">‚úÖ Acertos</h3><div style="font-size:2.2rem;font-weight:bold;color:var(--color-success)">${acertos}</div><p class="text-muted">de ${total}</p></div>
          <div class="card text-center" style="background:var(--color-primary-light)"><h3 style="color:var(--color-primary);margin-bottom:.5rem">üìä Percentual</h3><div style="font-size:2.2rem;font-weight:bold;color:var(--color-primary)">${perc}%</div><p class="text-muted">aproveitamento</p></div>
          <div class="card text-center" style="background:var(--color-warning-light)"><h3 style="color:var(--color-warning);margin-bottom:.5rem">‚è±Ô∏è Tempo</h3><div style="font-size:2.2rem;font-weight:bold;color:var(--color-warning)">${formatarTempo(tempo)}</div><p class="text-muted">total</p></div>
        </div>
        <div class="card" style="background:${perc>=70?'var(--color-success-light)':'var(--color-warning-light)'}"><h3 style="color:${perc>=70?'var(--color-success)':'var(--color-warning)'}">${perc>=70?'üéâ Parab√©ns!':'üìö Continue estudando!'}</h3><p>${perc>=70?'Bom dom√≠nio do conte√∫do.':'Revise os t√≥picos e tente novamente.'}</p></div>`;
    };

    const gerarAnaliseDescritores = () => {
      const a={}; estadoApp.respostas.forEach((r,idx)=>{ const q=QUESTOES[idx]; const d=q.descritor; if(!a[d]) a[d]={total:0,acertos:0,competencia:q.competencia,dificuldade:q.dificuldade}; a[d].total++; if(r?.correta) a[d].acertos++; }); return a;
    };

    const salvarResultadoAutomatico = () => {
      const acertos = estadoApp.respostas.filter(r=>r?.correta).length; const total=QUESTOES.length; const perc=Math.round((acertos/total)*100);
      const resultado = { id:gerarId(), nome:estadoApp.nomeAluno, score:acertos, total, percentual:perc, tempo_total:Math.round((estadoApp.fimQuiz-estadoApp.inicioQuiz)/1000), timestamp:estadoApp.fimQuiz.toISOString(), respostas:estadoApp.respostas, questoes:QUESTOES, analise_descritores: gerarAnaliseDescritores() };
      salvarResultadoGitHub(resultado);
    };

    // ===== DASHBOARD =====
    const abrirDashboard = async () => { mostrarTela('dashboard'); $('lastUpdate').textContent='üïí Carregando...'; await carregarResultados(); atualizarDashboard(); autoRefreshDashboard(); };

    const atualizarDashboard = () => {
      const rs = estadoApp.resultados || [];
      if(rs.length===0){$('totalAlunos').textContent='0';$('mediaGeral').textContent='-';$('taxaAprovacao').textContent='-';$('lastUpdate').textContent='üïí Nenhum resultado'; atualizarTabelaResultados([]); $('analiseQuestoes').innerHTML=''; $('analiseDescritores').innerHTML=''; return}
      const n = rs.length; const media = Math.round(rs.reduce((acc,r)=>acc+(r.percentual||0),0)/n); const aprov = rs.filter(r=>r.percentual>=70).length; const taxa = Math.round((aprov/n)*100);
      $('totalAlunos').textContent=n; $('mediaGeral').textContent=media+'%'; $('taxaAprovacao').textContent=taxa+'%'; $('resultadosCount').textContent=n; $('lastUpdate').textContent=`üïí √öltima atualiza√ß√£o: ${formatarData(Date.now())}`;
      atualizarTabelaResultados(rs); gerarAnaliseQuestoes(rs); gerarAnaliseDescritoresDashboard(rs);
    };

    const atualizarTabelaResultados = (rs) => {
      const tbody = $('tabelaResultados').querySelector('tbody'); tbody.innerHTML='';
      [...rs].sort((a,b)=>b.percentual-a.percentual).forEach((r,i)=>{
        const tr=document.createElement('tr'); const status = r.percentual>=70?'<span style="color:var(--color-success)">‚úÖ Aprovado</span>':'<span style="color:var(--color-warning)">üìö Recupera√ß√£o</span>';
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHTML(r.nome)}</td><td>${r.score}/${r.total}</td><td><strong>${r.percentual}%</strong></td><td>${formatarData(r.timestamp)}</td><td>${status}</td><td><button class="btn btn-sm btn-secondary" onclick="verDetalhes('${r.id}')">üëÅÔ∏è Ver</button></td>`; tbody.appendChild(tr);
      });
    };

    const gerarAnaliseQuestoes = (rs) => {
      if(rs.length===0) return; const a={}; QUESTOES.forEach(q=>a[q.id]={texto:q.texto,descritor:q.descritor,total_respostas:0,acertos:0,percentual_acerto:0});
      rs.forEach(r=>r.respostas?.forEach((resp,idx)=>{ const id=QUESTOES[idx].id; a[id].total_respostas++; if(resp?.correta) a[id].acertos++; }));
      Object.values(a).forEach(x=>{ if(x.total_respostas>0) x.percentual_acerto=Math.round((x.acertos/x.total_respostas)*100); });
      const cont=$('analiseQuestoes'); cont.innerHTML = Object.values(a).map(item=>{ const cor=item.percentual_acerto>=70?'var(--color-success)':(item.percentual_acerto>=50?'var(--color-warning)':'var(--color-error)'); return `<div class="mb-3 p-3" style="background:var(--bg-secondary);border-radius:8px;border-left:4px solid ${cor}"><div style="display:flex;justify-content:space-between;align-items:center"><div style="flex:1"><div style="font-weight:500">${escapeHTML(item.texto).slice(0,80)}...</div><div class="text-muted" style="font-size:.85rem">${escapeHTML(item.descritor)}</div></div><div style="text-align:right"><div style="font-size:1.4rem;font-weight:bold;color:${cor}">${item.percentual_acerto}%</div><div class="text-muted" style="font-size:.8rem">${item.acertos}/${item.total_respostas} acertos</div></div></div></div>`; }).join('');
    };

    const gerarAnaliseDescritoresDashboard = (rs) => {
      const a={}; rs.forEach(r=>{ if(r.analise_descritores){ for(const [d,dados] of Object.entries(r.analise_descritores)){ if(!a[d]) a[d]={competencia:dados.competencia,total_questoes:0,total_acertos:0,total_alunos:0}; a[d].total_questoes+=dados.total; a[d].total_acertos+=dados.acertos; a[d].total_alunos++; } } });
      const cont=$('analiseDescritores'); cont.innerHTML = Object.entries(a).map(([d,x])=>{ const p=Math.round((x.total_acertos/x.total_questoes)*100)||0; const cor=p>=70?'var(--color-success)':(p>=50?'var(--color-warning)':'var(--color-error)'); return `<div class="mb-3 p-3" style="background:var(--bg-secondary);border-radius:8px;border-left:4px solid ${cor}"><div style="display:flex;justify-content:space-between;align-items:center"><div style="flex:1"><div style="font-weight:500">${escapeHTML(d)}</div><div class="text-muted" style="font-size:.85rem">${escapeHTML(x.competencia||'')}</div><div class="text-muted" style="font-size:.8rem">${x.total_alunos} alunos avaliados</div></div><div style="text-align:right"><div style="font-size:1.4rem;font-weight:bold;color:${cor}">${p}%</div><div class="text-muted" style="font-size:.8rem">${x.total_acertos}/${x.total_questoes} acertos</div></div></div></div>`; }).join('');
    };

    // Exposto globalmente para o bot√£o da tabela
    window.verDetalhes = (id) => {
      const r = (estadoApp.resultados||[]).find(x=>x.id===id); if(!r){alert('Resultado n√£o encontrado.');return}
      const linhas = r.respostas.map((resp,i)=>`Q${i+1}: ${resp?.correta?'‚úîÔ∏è':'‚ùå'} (resp=${String.fromCharCode(65+(resp?.resposta??-1))})`).join('\n');
      alert(`Aluno: ${r.nome}\nPercentual: ${r.percentual}%\nTempo: ${r.tempo_total}s\n\nDetalhes:\n${linhas}`);
    };

    // ===== AUXILIARES =====
    const copiarLink = () => navigator.clipboard.writeText(window.location.href).then(()=>alert('Link copiado!')).catch(()=>alert('Erro ao copiar.'));

    const exportarTodosDados = async () => { await carregarResultados(); const dados={configuracao:estadoApp.githubConfig,questoes:QUESTOES,resultados:estadoApp.resultados,exportado_em:new Date().toISOString()}; const blob=new Blob([JSON.stringify(dados,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`quiz-dados-${hojeISO()}.json`; a.click(); };

    const inicializarHome = () => { verificarStatusGitHub(); atualizarQRLink(); carregarResultados().then(rs=>{$('resultadosCount').textContent=rs.length;}); };

    // Auto-refresh no dashboard (a cada 20 s enquanto aberto)
    let refreshTimer=null; const autoRefreshDashboard=()=>{ if(refreshTimer) clearInterval(refreshTimer); refreshTimer=setInterval(async()=>{ if(estadoApp.telaAtual==='dashboard'){ await carregarResultados(); atualizarDashboard(); } },20000); };

    // ===== EVENTOS =====
    const inicializarEventListeners = () => {
      $('btnConfigurar').addEventListener('click', configurarGitHub);
      $('btnModoLocal').addEventListener('click', usarModoLocal);
      $('btnIniciar').addEventListener('click', iniciarQuiz);
      $('btnSair').addEventListener('click', ()=>mostrarTela('home'));
      $('btnRefazer').addEventListener('click', ()=>{ mostrarTela('home'); $('alunoNome').value=''; });
      $('btnVoltar').addEventListener('click', ()=>mostrarTela('home'));
      $('btnQrLink').addEventListener('click', atualizarQRLink);
      $('btnCopiarLink').addEventListener('click', copiarLink);
      $('btnDashboard').addEventListener('click', abrirDashboard);
      $('btnFecharDashboard').addEventListener('click', ()=>mostrarTela('home'));
      $('btnAtualizarDados').addEventListener('click', async ()=>{ await carregarResultados(); atualizarDashboard(); });
      $('btnConfigurarRepo').addEventListener('click', ()=>mostrarTela('config'));
      $('btnExportarDados').addEventListener('click', exportarTodosDados);
      document.addEventListener('keydown', (e)=>{ if(estadoApp.telaAtual==='quiz'){ const n=parseInt(e.key); if(n>=1&&n<=4){ const ops=$$('.quiz-option'); if(ops[n-1]) ops[n-1].click(); } } });
    };

    // ===== BOOT =====
    const inicializar = () => {
      const cfg = localStorage.getItem('githubConfig'); if(cfg){ try{ const c=JSON.parse(cfg); estadoApp.githubConfig={...estadoApp.githubConfig, ...c}; if(estadoApp.githubConfig.configured){ mostrarTela('home'); inicializarHome(); } }catch(e){ console.warn('Config inv√°lida'); } }
      inicializarEventListeners();
      if(!estadoApp.githubConfig.configured) mostrarTela('config');
    };
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', inicializar); else inicializar();
  </script>
</body>
</html>


